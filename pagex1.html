<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 助手</title>
<style>
  /* 保持原有样式不变 */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', sans-serif;
  }

  body {
    background: #e3f2fd;
    user-select: none;
  }

  #chat-container {
    position: fixed;
    resize: both;
    overflow: hidden;
    min-width: 300px;
    min-height: 400px;
    max-width: 800px;
    max-height: 90vh;
    background: #fff;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    border-radius: 12px;
    will-change: transform;
    transition: transform 0.1s ease-out;
  }

  .drag-area {
    height: 40px;
    background: #2196F3;
    border-radius: 12px 12px 0 0;
    cursor: move;
  }

  #chat-messages {
    height: calc(100% - 110px);
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .message {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 15px;
    animation: fadeIn 0.3s ease-in;
  }

  .user-message {
    align-self: flex-end;
    background: #2196F3;
    color: white;
    border-bottom-right-radius: 3px;
  }

  .ai-message {
    align-self: flex-start;
    background: #f5f5f5;
    color: #333;
    border-bottom-left-radius: 3px;
  }

  #input-container {
    position: absolute;
    bottom: 0;
    width: 100%;
    padding: 15px;
    background: #fff;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
  }

  #user-input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 12px;
    outline: none;
    font-size: 16px;
    transition: border-color 0.3s;
  }

  #user-input:focus {
    border-color: #2196F3;
  }

  #send-button {
    padding: 12px 24px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
  }

  #send-button:hover {
    background: #1976D2;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* 添加加载状态样式 */
  #send-button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
</style>
</head>
<body>
<div id="chat-container">
  <div class="drag-area"></div>
  
  <div id="chat-messages"></div>
  
  <div id="input-container">
    <input type="text" id="user-input" placeholder="输入消息...">
    <button id="send-button">发送</button>
  </div>
</div>

<script>
  (() => {
    const container = document.getElementById('chat-container');
    const dragArea = document.querySelector('.drag-area');
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');

    // 初始化位置
    container.style.transform = `translate(${screen.width - 420}px, 50px)`;

    // 拖动逻辑保持不变
    let isDragging = false;
    let startX = 0, startY = 0;
    let initialX = 0, initialY = 0;

    const handleMouseDown = (e) => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      const transform = container.style.transform.match(/translate\(([^,]+),([^)]+)\)/);
      initialX = parseFloat(transform[1]);
      initialY = parseFloat(transform[2]);

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    };

    const handleMouseMove = (e) => {
      if (!isDragging) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      const newX = Math.min(window.innerWidth - container.offsetWidth,
        Math.max(0, initialX + dx));
      const newY = Math.min(window.innerHeight - container.offsetHeight,
        Math.max(0, initialY + dy));

      requestAnimationFrame(() => {
        container.style.transform = `translate(${newX}px, ${newY}px)`;
      });
    };

    const handleMouseUp = () => {
      isDragging = false;
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };

    dragArea.addEventListener('mousedown', handleMouseDown);

    // 新的消息处理逻辑
    const addMessage = (text, sender) => {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;
      messageDiv.textContent = text;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // 发送消息到后端
    const sendMessage = async () => {
      const message = userInput.value.trim();
      if (!message) return;

      // 禁用输入和发送按钮
      userInput.disabled = true;
      sendButton.disabled = true;

      // 显示用户消息
      addMessage(message, 'user');
      userInput.value = '';

      try {
        // 发送请求到后端
        const response = await fetch('http://127.0.0.1:11434/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ question: message }),
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        // 读取流式响应
        const reader = response.body.getReader();
        let accumulatedResponse = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          // 将 Uint8Array 转换为文本
          const chunk = new TextDecoder().decode(value);
          accumulatedResponse += chunk;
        }

        // 显示AI响应
        addMessage(accumulatedResponse, 'ai');
      } catch (error) {
        console.error('Error:', error);
        addMessage('抱歉，发生了错误，请稍后重试。', 'ai');
      } finally {
        // 重新启用输入和发送按钮
        userInput.disabled = false;
        sendButton.disabled = false;
        userInput.focus();
      }
    };

    // 事件监听
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  })();
</script>
</body>
</html>